  {% extends "layout.html" %}

  {% block content %}
  <h1 class="mb-4">Products</h1>

  <form method="get" class="row g-3 mb-4">
    <div class="col-md-4">
      <label class="form-label">Search by title</label>
      <input
        type="text"
        class="form-control"
        name="q"
        placeholder="Keyword..."
        value="{{ search or '' }}"
      >
    </div>

    <div class="col-md-4">
      <label class="form-label">Category</label>
      <select name="category" class="form-select">
        <option value="">-- All --</option>
        {% for c in categories %}
          <option value="{{ c.Category_ID }}"
                  {% if category_filter == c.Category_ID %}selected{% endif %}>
           {{ c.Hierarchy }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Sort</label>
      <select name="sort" class="form-select">
        <option value="title_asc"  {% if sort == 'title_asc'  %}selected{% endif %}>Title ↑</option>
        <option value="title_desc" {% if sort == 'title_desc' %}selected{% endif %}>Title ↓</option>
        <option value="brand_asc"  {% if sort == 'brand_asc'  %}selected{% endif %}>Brand ↑</option>
        <option value="brand_desc" {% if sort == 'brand_desc' %}selected{% endif %}>Brand ↓</option>
        <option value="weight_asc" {% if sort == 'weight_asc' %}selected{% endif %}>Weight ↑</option>
        <option value="weight_desc"{% if sort == 'weight_desc'%}selected{% endif %}>Weight ↓</option>
      </select>
    </div>

    <div class="col-md-1 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Apply</button>
    </div>
  </form>

  <div class="mb-3 text-end">
    <a href="{{ url_for('product_create') }}" class="btn btn-success">
      + New Product
    </a>
  </div>

  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th>ASIN</th>
        <th>Title</th>
        <th>Brand</th>
        <th>Category</th>
        <th>Weight</th>
        <th>Min Price</th>
        <th style="width: 220px;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in products %}
        <tr {% if selected_asin == p.ASIN %}class="table-primary"{% endif %}>
          <td>{{ p.ASIN }}</td>

          <!-- Click vào Title để xem offers phía dưới -->
          <td>
            <a href="{{ url_for('product_list',
                                q=search,
                                category=category_filter,
                                sort=sort,
                                asin=p.ASIN) }}">
              {{ p.Product_title }}
            </a>
          </td>

          <td>{{ p.Brand }}</td>
          <td>{{ p.Hierarchy }}</td>
          <td>{{ p.Weight }}</td>

          <td>
            {% if p.MinPrice is not none %}
              {{ "{:,.2f}".format(p.MinPrice) }}
            {% else %}
              N/A
            {% endif %}
          </td>

          <td>
            <a href="{{ url_for('product_edit', asin=p.ASIN) }}"
              class="btn btn-sm btn-outline-primary me-1">
              Edit
            </a>

            <form method="post"
                  action="{{ url_for('product_delete', asin=p.ASIN) }}"
                  style="display:inline-block"
                  onsubmit="return confirm('Delete this product?');">
              <button type="submit" class="btn btn-sm btn-outline-danger">
                Delete
              </button>
            </form>
          </td>

      {% endfor %}

      {% if products|length == 0 %}
        <tr>
          <td colspan="7" class="text-center text-muted">
            No products found.
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>

  {% if selected_product %}
    <div class="card mt-4">
      <div class="card-header">
        Offers for {{ selected_product.Product_title }} ({{ selected_product.ASIN }})
      </div>
      <div class="card-body">
        <p class="text-muted mb-3">
          Brand: <strong>{{ selected_product.Brand }}</strong> |
          Category: {{ selected_product.Hierarchy }}
        </p>

        <table class="table table-sm table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>Offer ID</th>
              <th>Seller ID</th>
              <th>Storefront</th>
              <th>Seller status</th>
              <th>Condition</th>
              <th>Price</th>
              <th>Currency</th>
              <th>Fulfill method</th>
              <th>Handling time</th>
              <th>Inventory</th>
              <th style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for o in offers %}
              <tr>
                <td>{{ o.Offer_ID }}</td>
                <td>{{ o.Seller_ID }}</td>
                <td>{{ o.Storefront_name }}</td>
                <td>{{ o.Operation_status }}</td>
                <td>{{ o.Item_condition }}</td>
                <td>
                  {% if o.Price is not none %}
                    {{ "{:,.2f}".format(o.Price) }}
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>{{ o.Currency }}</td>
                <td>{{ o.Fulfill_method }}</td>
                <td>{{ o.Handling_time }}</td>
                <td>{{ o.Inventory_pos }}</td>
                <td>
                  <a href="{{ url_for('cart_add_offer', offer_id=o.Offer_ID) }}"
                    class="btn btn-sm btn-outline-success">
                    Add to cart
                  </a>
                </td>
              </tr>
            {% endfor %}

            {% if offers|length == 0 %}
              <tr>
                <td colspan="11" class="text-center text-muted">
                  No offers for this product.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

  {% endblock %}
